# 登录日志功能指南

## 功能概述

系统现在支持详细的用户登录信息记录，包括IP地址、登录环境、设备信息等，并提供管理员查看所有账号登录情况的功能。

## 主要功能

### 1. 登录信息记录
- **用户信息**: 用户ID、邮箱、姓名
- **时间信息**: 登录时间、退出时间、会话时长
- **网络信息**: IP地址、User Agent
- **设备信息**: 浏览器名称/版本、操作系统、设备类型
- **安全信息**: 设备指纹、可疑登录检测、风险等级

### 2. 管理员功能
- 查看所有用户的登录记录
- 筛选和搜索登录日志
- 查看活跃会话
- 检测可疑登录行为
- 统计登录数据

## 数据模型

### LoginLog 模型字段

```typescript
interface LoginLog {
  id: string                    // 日志ID
  userId: string               // 用户ID
  userEmail: string            // 用户邮箱
  userName: string             // 用户名称
  
  // 登录信息
  loginTime: DateTime          // 登录时间
  logoutTime?: DateTime        // 退出时间
  sessionDuration?: number     // 会话时长（分钟）
  
  // 网络信息
  ipAddress?: string           // IP地址
  userAgent?: string           // 浏览器信息
  browserName?: string         // 浏览器名称
  browserVersion?: string      // 浏览器版本
  osName?: string              // 操作系统名称
  osVersion?: string           // 操作系统版本
  deviceType?: string          // 设备类型
  fingerprint?: string         // 设备指纹
  
  // 地理位置信息
  country?: string             // 国家
  region?: string              // 地区/省份
  city?: string                // 城市
  
  // 登录状态
  isActive: boolean            // 是否活跃会话
  loginType: string            // 登录类型
  isSuspicious: boolean        // 是否可疑登录
  riskLevel: string            // 风险等级
}
```

## API接口

### GET /api/login-logs
获取登录日志列表

**查询参数:**
- `userId`: 用户ID（可选）
- `limit`: 返回数量限制（默认50）
- `type`: 日志类型（all/active）

**响应:**
```json
{
  "success": true,
  "data": [...],
  "count": 50
}
```

## 页面功能

### 管理员登录日志页面 (/admin/login-logs)

#### 功能特性
1. **筛选功能**
   - 按日志类型筛选（全部/活跃会话）
   - 按用户ID筛选
   - 设置显示数量

2. **统计信息**
   - 总登录次数
   - 活跃会话数
   - 可疑登录数
   - 设备类型分布

3. **详细日志表格**
   - 用户信息（姓名、邮箱、角色）
   - 登录时间（登录/退出时间）
   - 会话时长
   - 设备信息（浏览器、操作系统）
   - 网络信息（IP地址、地理位置）
   - 安全状态（风险等级、可疑标记）
   - 在线状态

#### 安全检测
- **IP地址变化检测**: 检测用户是否从不同IP登录
- **设备指纹检测**: 检测设备指纹变化
- **频繁登录检测**: 检测24小时内登录次数
- **风险等级评估**: 低风险/中风险/高风险

## 使用说明

### 1. 查看登录日志
1. 以管理员身份登录
2. 进入"登录日志"页面
3. 使用筛选条件查看特定日志
4. 查看详细的登录信息

### 2. 监控安全
1. 查看"可疑登录"统计
2. 检查高风险登录记录
3. 监控异常IP地址
4. 关注设备指纹变化

### 3. 会话管理
1. 查看"活跃会话"了解当前在线用户
2. 监控会话时长
3. 识别异常长时间会话

## 技术实现

### 设备信息获取
- 使用`User-Agent`解析浏览器和操作系统信息
- 通过HTTP头获取IP地址
- 生成设备指纹用于安全检测

### 安全检测算法
- IP地址变化检测
- 设备指纹对比
- 登录频率分析
- 地理位置异常检测

### 数据存储
- 使用PostgreSQL存储登录日志
- 支持大数据量查询
- 自动清理过期日志（可配置）

## 配置选项

### 环境变量
- `DATABASE_URL`: 数据库连接字符串
- 其他NextAuth.js配置

### 安全设置
- 可疑登录检测阈值
- 日志保留时间
- 风险等级评估规则

## 注意事项

1. **隐私保护**: 登录日志包含敏感信息，仅管理员可访问
2. **数据清理**: 建议定期清理过期日志
3. **性能优化**: 大量日志可能影响查询性能
4. **安全监控**: 定期检查可疑登录记录

## 测试

访问 `/test-login-log` 页面可以测试登录日志功能是否正常工作。

## 故障排除

### 常见问题
1. **数据库连接失败**: 检查DATABASE_URL配置
2. **权限错误**: 确保用户具有管理员权限
3. **数据不显示**: 检查数据库迁移是否完成

### 调试方法
1. 查看浏览器控制台错误
2. 检查服务器日志
3. 使用测试页面验证功能
